---
import { db, Users, Links, eq } from 'astro:db';
import Action from '@/components/ui/Action.astro';
import Input from '@/components/ui/Input.astro';
import Typography from '@/components/ui/Typography.astro';
import Layout from '@/layouts/Layout.astro';
import { getUser } from '@/lib/get-auth';

import EditIcon from '@/icons/Edit.astro';
import CheckIcon from '@/icons/Check.astro';

const { linkTitle } = Astro.params;
if (!linkTitle) return Astro.redirect('/');

const [link] = await db.select().from(Links).where(eq(Links.title, linkTitle));
const { url, userId } = link;

let isOwner = false;

if (userId) {
  const user = getUser({ cookies: Astro.cookies });
  const userDb = db.select().from(Users).where(eq(Users.id, userId));
  await Promise.all([user, userDb]).then(([user, [userDb]]) => {
    isOwner = user?.email === userDb.email;
  });
}
---

<Layout title={linkTitle}>
  <Typography as="h1" transition:name={`title-${linkTitle}`}
    >{linkTitle}</Typography
  >
  <div class="flex gap-2 items-baseline mb-2">
    <Typography
      id="link"
      as="a"
      variant="h2"
      class="block underline text-xl text-teal-300"
      href={url}
      transition:name={`link-${linkTitle}`}
    >
      {url}
    </Typography>
    <Input
      id="link-input"
      class="hidden text-lg w-max"
      transition:name={`link-${linkTitle}`}
      value={url}
    />
    <Action as="button" id="edit-link-button" variant="icon" hidden={!isOwner}>
      <EditIcon id="edit-icon" />
      <CheckIcon id="check-icon" class="hidden" />
    </Action>
  </div>
  <Action as="button" id="generate-qr-code"> Generate QR Code </Action>
  <Action id="copy-link-button" as="button"> Copy link </Action>
  <Action
    data-link={linkTitle}
    id="delete-link-button"
    as="button"
    hidden={!isOwner}
  >
    Delete link
  </Action>
  <div class="mt-2" id="qr-code-area" class="hidden"></div>
  <div id="modify-qr-code" class="hidden mt-4">
    <Action available={false} as="button" disabled>
      Customize your QR Code
    </Action>
    <Typography as="p" class="text-teal-400">Available soon</Typography>
  </div>
</Layout>
<script>
  import { generateQRCode } from '@/lib/generate-qr-code';
  import { navigate } from 'astro:transitions/client';

  document.addEventListener('astro:page-load', () => {
    const copyLinkButton = document.getElementById(
      'copy-link-button'
    ) as HTMLButtonElement;
    const link = document.getElementById('link') as HTMLAnchorElement;
    const url = link.href;

    const copyLink = () => {
      navigator.clipboard.writeText(url);
      const beforeText = copyLinkButton.textContent;
      copyLinkButton.textContent = 'Copiado!';
      copyLinkButton.disabled = true;
      setTimeout(() => {
        copyLinkButton.textContent = beforeText;
        copyLinkButton.disabled = false;
      }, 1000);
    };

    const generateQRCodeButton = document.getElementById(
      'generate-qr-code'
    ) as HTMLButtonElement;
    const qrCodeArea = document.getElementById(
      'qr-code-area'
    ) as HTMLDivElement;
    const modifyQRCodeButton = document.getElementById(
      'modify-qr-code'
    ) as HTMLButtonElement;

    const generateQR = () => {
      qrCodeArea.innerHTML = '';
      const qrCode = generateQRCode({
        linkTitle: '',
      });
      qrCode.append(qrCodeArea);
      qrCodeArea.classList.remove('hidden');
      modifyQRCodeButton.classList.remove('hidden');
    };
    const deleteLinkButton = document.getElementById(
      'delete-link-button'
    ) as HTMLAnchorElement;
    const title = deleteLinkButton.getAttribute('data-link') as string;
    const formData = new FormData();
    formData.append('title', title);

    const deleteLink = async () => {
      const response = await fetch(`/api/link?title=${title}`, {
        method: 'DELETE',
      });
      if (!response.ok) {
        alert('Error while deleting link');
        return;
      }
      navigate('/', {
        history: 'replace',
      });
    };

    const editLinkButton = document.getElementById(
      'edit-link-button'
    ) as HTMLButtonElement;
    const linkInput = document.getElementById('link-input') as HTMLInputElement;

    const checkIcon = document.getElementById(
      'check-icon'
    ) as HTMLButtonElement;
    const editIcon = document.getElementById('edit-icon') as HTMLButtonElement;

    const showTextbox = async () => {
      if (link.classList.contains('hidden')) {
        const newUrl = linkInput.value;
        const title = deleteLinkButton.getAttribute('data-link') as string;

        const url = new URL('/api/link', window.location.origin);
        url.searchParams.append('title', title);
        const formData = new FormData();
        formData.append('newUrl', newUrl);
        await fetch(url.toString(), {
          method: 'PUT',
          body: formData,
        });

        link.textContent = newUrl;
        link.href = newUrl;
      }

      linkInput.classList.toggle('hidden');
      link.classList.toggle('hidden');
      checkIcon.classList.toggle('hidden');
      editIcon.classList.toggle('hidden');
    };

    copyLinkButton.addEventListener('click', copyLink);
    generateQRCodeButton.addEventListener('click', generateQR);
    deleteLinkButton.addEventListener('click', deleteLink);
    editLinkButton.addEventListener('click', showTextbox);
  });
</script>
